@page "/submarine"
@using System.ComponentModel.DataAnnotations
@using System.Text
@using System.Text.Json.Serialization
@using ffxiv_apps.Component
@using ffxiv_apps.Domain
@using Microsoft.AspNetCore.Components.WebAssembly.Hosting

<PageTitle>FF14 Apps - Í≥†ÏûâÎßàÏÉ§Ìò∏</PageTitle>

<div class="row mb-3">
    <div class="col-md-3 col-sm-6">
        <label class="p-lg-1">ÎÖÑÎèÑ</label>
        <NumberInput TValue="int" @bind-Value="_searchYear" Placeholder="ÎÖÑÎèÑ"/>
    </div>

    <div class="col-md-2 col-sm-6">
        <label class="p-lg-1">Ïõî</label>
        <NumberInput TValue="int" @bind-Value="_searchMonth" Placeholder="Ïõî"/>
    </div>

    <div class="col-md-3 col-sm-4" style="padding-top: 1.875em">
        <Button Color="ButtonColor.Primary" @onclick="SoldItemReload">
            <Icon Name="IconName.Search"/>
            Ï°∞Ìöå
        </Button>
    </div>
</div>

<div class="mb-3">
    <Collapse @ref="_collapse">
        <Card>
            <CardBody>
                <EditForm EditContext="@_editContext" OnValidSubmit="HandleValidSubmit">
                    <DataAnnotationsValidator/>

                    <div class="form-group row mb-3">
                        <label class="col-md-2 col-form-label">Ïù∏Ï¶ùÌÜ†ÌÅ∞: <span class="text-danger">*</span></label>
                        <div class="col-md-10">
                            <TextInput @bind-Value="_authToken" Placeholder="Ïù∏Ï¶ùÌÜ†ÌÅ∞"/>
                        </div>
                    </div>

                    <div class="form-group row mb-3">
                        <label class="col-md-2 col-form-label">ÏïÑÏù¥ÌÖúÎ™Ö: <span class="text-danger">*</span></label>
                        <div class="col-md-10">
                            <TextInput Value="@_soldItemInput.ItemName" ValueExpression="() => _soldItemInput.ItemName"
                                       ValueChanged="value => ItemNameChanged(value)" Placeholder="ÏïÑÏù¥ÌÖúÎ™Ö"
                                       Class="ime-active"/>
                            <ValidationMessage For="@(() => _soldItemInput.ItemName)"/>
                        </div>
                        <div class="mt-1 col-md-10">
                            <Image Src="@_soldItemInput.ItemIconUrl" Style="width: 40px; height: 40px;"/>
                            @_soldItemInput.ItemDesc
                        </div>
                    </div>

                    <div class="form-group row mb-3">
                        <label class="col-md-2 col-form-label">ÏàòÎüâ: <span class="text-danger">*</span></label>
                        <div class="col-md-10">
                            <NumberInput TValue="int" @bind-Value="_soldItemInput.Quantity" Placeholder="ÌåêÎß§ÏàòÎüâ"
                                         Class="ime-active"/>
                            <ValidationMessage For="@(() => _soldItemInput.Quantity)"/>
                        </div>
                    </div>

                    <div class="form-group row mb-3">
                        <label class="col-md-2 col-form-label">ÌåêÎß§Í∞ÄÍ≤©: <span class="text-danger">*</span></label>
                        <div class="col-md-10">
                            <NumberInput TValue="int" @bind-Value="_soldItemInput.Price" Placeholder="ÌåêÎß§Í∞ÄÍ≤©"
                                         Class="ime-active"/>
                            <ValidationMessage For="@(() => _soldItemInput.Price)"/>
                        </div>
                    </div>

                    <div class="form-group row mb-3">
                        <label class="col-md-2 col-form-label">ÌåêÎß§Ïùº: <span class="text-danger">*</span></label>
                        <div class="col-md-10">
                            <DateInput TValue="DateOnly" @bind-Value="_soldItemInput.SoldDate" Placeholder="ÌåêÎß§Ïùº"
                                       Class="ime-active"/>
                            <ValidationMessage For="@(() => _soldItemInput.SoldDate)"/>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12 text-right">
                            <Button Type="ButtonType.Button" Color="ButtonColor.Secondary" Class="float-end"
                                    @onclick="ResetForm">Ï¥àÍ∏∞Ìôî
                            </Button>
                            <Button Type="ButtonType.Submit" Color="ButtonColor.Primary" Class="float-end me-2">Ï†ÄÏû•
                            </Button>
                        </div>
                    </div>
                </EditForm>
            </CardBody>
        </Card>
    </Collapse>
</div>

<div class="mb-3">
    <div class="mb-1">
        <Button Color="ButtonColor.Primary" @onclick="ToggleContentAsync">
            <Icon Name="IconName.Pencil"/>
        </Button>

        <Button Color="ButtonColor.Primary" @onclick="ShowRecentSoldPriceSumModal">
            <Icon Name="IconName.Calculator"/>
        </Button>

        <Button Color="ButtonColor.Primary" @onclick="SoldItemReload">
            <Icon Name="IconName.Recycle"/>
        </Button>

        <Button Color="ButtonColor.Danger" @onclick="DeleteSelectedItem">
            <Icon Name="IconName.Trash"/>
        </Button>

        <Button Color="ButtonColor.Success">
            ü™ô Ï¥ùÏàòÏûÖ: @_totalPrice.ToString("N0")
        </Button>
    </div>

    <Grid
        @ref="_grid"
        TItem="SoldItem"
        DataProvider="SoldItemDataProvider"
        Class="table table-hover table-bordered table-striped"
        EmptyText="ÌÖÖ!"
        AllowSelection="true"
        SelectionMode="GridSelectionMode.Single"
        SelectedItemsChanged="OnSelectedItemsChanged"
        Responsive="true">

        <GridColumns>
            <GridColumn TItem="SoldItem" HeaderText="ÏïÑÏù¥ÌÖú" PropertyName="ItemName"
                        HeaderTextAlignment="Alignment.Center" TextAlignment="Alignment.Start">
                <Image Src="@context.ItemIconUrl" Style="width: 40px; height: 40px;" Alt="@context.ItemName"/>
                <span>@context.ItemName</span>
                <span>‚úï</span>
                <span><Badge Color="BadgeColor.Secondary">@context.Quantity</Badge></span>
            </GridColumn>

            <GridColumn TItem="SoldItem" HeaderText="ü™ô ÌåêÎß§Í∞ÄÍ≤©" PropertyName="Price"
                        HeaderTextAlignment="Alignment.Center">
                @context.Price?.ToString("N0")
            </GridColumn>

            <GridColumn TItem="SoldItem" HeaderText="ÌåêÎß§Ïùº" PropertyName="SoldDate"
                        HeaderTextAlignment="Alignment.Center">
                @context.SoldDate
            </GridColumn>
        </GridColumns>
    </Grid>
</div>

<Modal @ref="_recentSoldPriceSumModal"></Modal>

<Toasts class="p-3" AutoHide="true" Delay="4000" Placement="ToastsPlacement.TopRight"/>

<style>
    .ime-active {
        -webkit-ime-mode: active;
        -moz-ime-mode: active;
        -ms-ime-mode: active;
        ime-mode: active;
    }
</style>

@code {
    [Inject] ToastService ToastService { get; set; } = null!;

    [Inject] HttpClient HttpClient { get; set; } = null!;

    [Inject] IWebAssemblyHostEnvironment Env { get; set; } = null!;

    [Inject] PreloadService PreloadService { get; set; } = null!;

    private Grid<SoldItem> _grid = null!;

    private Collapse _collapse = null!;

    private int _searchYear;

    private int _searchMonth;

    private string? _authToken;

    private IEnumerable<SoldItem> _soldItems = [];

    private SoldItemInput _soldItemInput = new();

    private EditContext? _editContext;

    private SoldItem? _soldItemForDelete;

    private int _totalPrice;

    private Modal _recentSoldPriceSumModal = null!;

    private async Task ShowRecentSoldPriceSumModal()
    {
        RecentSoldPriceSum[] items = [];

        try
        {
            PreloadService.Show();

            using var response = await HttpClient.GetAsync(WithApiPath("recentSoldPriceSum"));

            if (response.IsSuccessStatusCode)
            {
                items = (await response.Content.ReadFromJsonAsync<RecentSoldPriceSum[]>())!;
            }
        }
        catch (Exception)
        {
            // ignore
        }
        finally
        {
            PreloadService.Hide();
        }

        var parameters = new Dictionary<string, object>
        {
            { "Items", items }
        };

        await _recentSoldPriceSumModal.ShowAsync<RecentSoldPriceSumModalComponent>(title: "ÏµúÍ∑º Ï¥ùÏàòÏûÖ", parameters: parameters);
    }

    protected override void OnInitialized()
    {
        var now = DateTime.Now;
        _searchYear = now.Year;
        _searchMonth = now.Month;
        _editContext = new EditContext(_soldItemInput);

        Task.Run(async () => await SoldItemReload());
        base.OnInitialized();
    }

    private string WithApiPath(string? uri = null)
    {
        var sb = new StringBuilder();

        if (!Env.IsDevelopment())
        {
            sb.Append("ff14");
        }

        sb.Append("/api/submarine");

        if (!string.IsNullOrEmpty(uri))
        {
            sb.Append($"/{uri}");
        }

        return sb.ToString();
    }

    private async Task<GridDataProviderResult<SoldItem>> SoldItemDataProvider(GridDataProviderRequest<SoldItem> request)
    {
        return await Task.FromResult(request.ApplyTo(_soldItems));
    }

    private async Task<SoldItem[]> GetSoldItems()
    {
        var startDate = new DateTime(_searchYear, _searchMonth, 1, 0, 0, 0);
        var daysInMonth = DateTime.DaysInMonth(startDate.Year, startDate.Month);
        var endDate = new DateTime(_searchYear, _searchMonth, daysInMonth, 23, 59, 59);

        var param = new Dictionary<string, DateOnly>
        {
            { "startDate", DateOnly.FromDateTime(startDate) },
            { "endDate", DateOnly.FromDateTime(endDate) }
        };

        using var response = await HttpClient.PostAsJsonAsync(WithApiPath("list"), param);

        if (response.IsSuccessStatusCode)
        {
            return (await response.Content.ReadFromJsonAsync<SoldItem[]>())!;
        }

        return [];
    }

    private async Task ToggleContentAsync() => await _collapse.ToggleAsync();

    public async Task HandleValidSubmit()
    {
        if (string.IsNullOrWhiteSpace(_authToken))
        {
            ToastService.Notify(new ToastMessage
            (
                type: ToastType.Danger,
                iconName: IconName.Bug,
                title: "Ï†ÄÏû•Ïã§Ìå®!",
                helpText: $"{DateTime.Now.ToLocalTime()}",
                message: "Ïù∏Ï¶ùÌÜ†ÌÅ∞Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§."
            ));
            return;
        }

        _soldItemInput.Authorization = _authToken;

        try
        {
            PreloadService.Show();

            using var response = await HttpClient.PostAsJsonAsync(WithApiPath(), _soldItemInput);

            if (response.IsSuccessStatusCode)
            {
                ToastService.Notify(new ToastMessage
                (
                    type: ToastType.Success,
                    iconName: IconName.Check2All,
                    title: "Ï†ÄÏû•ÏôÑÎ£å!",
                    helpText: $"{DateTime.Now.ToLocalTime()}",
                    message: "Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§."
                ));

                _soldItemInput.InitializeInput();
                _editContext = new EditContext(_soldItemInput);

                await LoadSoldItem();
            }
            else
            {
                ToastService.Notify(new ToastMessage
                (
                    type: ToastType.Danger,
                    iconName: IconName.Bug,
                    title: "Ï†ÄÏû•Ïã§Ìå®!",
                    helpText: $"{DateTime.Now.ToLocalTime()}",
                    message: "Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§."
                ));
            }
        }
        catch (Exception e)
        {
            NotifySystemError(e.Message);
        }
        finally
        {
            PreloadService.Hide();
        }
    }

    private void ResetForm()
    {
        _soldItemInput.Reset();
        _editContext = new EditContext(_soldItemInput);
    }

    private async Task ItemNameChanged(string itemName)
    {
        if (string.IsNullOrWhiteSpace(itemName))
        {
            return;
        }

        _soldItemInput.ItemId = 0;
        _soldItemInput.ItemIcon = 0;
        _soldItemInput.ItemName = string.Empty;

        try
        {
            using var response = await HttpClient.GetAsync(WithApiPath($"item/{itemName}"));

            if (response.IsSuccessStatusCode)
            {
                var message = (await response.Content.ReadFromJsonAsync<ItemDetail>())!;

                _soldItemInput.ItemId = message.Id;
                _soldItemInput.ItemIcon = message.Icon;
                _soldItemInput.ItemName = message.Name;
            }
            else
            {
                ToastService.Notify(new ToastMessage
                (
                    type: ToastType.Danger,
                    iconName: IconName.Bug,
                    title: "ÏïÑÏù¥ÌÖúÏ°∞Ìöå Ïã§Ìå®!",
                    helpText: $"{DateTime.Now.ToLocalTime()}",
                    message: "ÏïÑÏù¥ÌÖúÏ†ïÎ≥¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§."
                ));
            }
        }
        catch (Exception e)
        {
            NotifySystemError(e.Message);
        }
    }

    private Task OnSelectedItemsChanged(HashSet<SoldItem>? soldItems)
    {
        if (soldItems is not null && soldItems.Any())
        {
            _soldItemForDelete = soldItems.First();
        }
        else
        {
            _soldItemForDelete = null;
        }

        return Task.CompletedTask;
    }

    private async Task DeleteSelectedItem()
    {
        if (string.IsNullOrWhiteSpace(_authToken))
        {
            ToastService.Notify(new ToastMessage
            (
                type: ToastType.Danger,
                iconName: IconName.Bug,
                title: "ÏÇ≠Ï†úÏã§Ìå®!",
                helpText: $"{DateTime.Now.ToLocalTime()}",
                message: "Ïù∏Ï¶ùÌÜ†ÌÅ∞Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§."
            ));
            return;
        }

        if (_soldItemForDelete is null)
        {
            ToastService.Notify(new ToastMessage
            (
                type: ToastType.Danger,
                iconName: IconName.Bug,
                title: "ÏÇ≠Ï†úÏã§Ìå®!",
                helpText: $"{DateTime.Now.ToLocalTime()}",
                message: "ÏÇ≠Ï†úÌï† ÏïÑÏù¥ÌÖúÏùÑ ÏÑ†ÌÉùÌï¥Ïïº Ìï©ÎãàÎã§."
            ));
            return;
        }

        var body = new Dictionary<string, object>
        {
            { "id", _soldItemForDelete.Id! },
            { "authorization", _authToken }
        };

        var request = new HttpRequestMessage
        {
            Content = JsonContent.Create(body),
            Method = HttpMethod.Delete,
            RequestUri = new Uri(WithApiPath(_soldItemForDelete.Id.ToString()), UriKind.Relative)
        };

        try
        {
            PreloadService.Show();

            using var response = await HttpClient.SendAsync(request);

            if (response.IsSuccessStatusCode)
            {
                ToastService.Notify(new ToastMessage
                (
                    type: ToastType.Success,
                    iconName: IconName.Check2All,
                    title: "ÏÇ≠Ï†úÏôÑÎ£å!",
                    helpText: $"{DateTime.Now.ToLocalTime()}",
                    message: "ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§."
                ));
            }
            else
            {
                ToastService.Notify(new ToastMessage
                (
                    type: ToastType.Danger,
                    iconName: IconName.Bug,
                    title: "ÏÇ≠Ï†úÏã§Ìå®!",
                    helpText: $"{DateTime.Now.ToLocalTime()}",
                    message: "ÏÇ≠Ï†úÌï† ÏïÑÏù¥ÌÖúÏù¥ ÏóÜÏäµÎãàÎã§."
                ));
            }

            await LoadSoldItem();
        }
        catch (Exception e)
        {
            NotifySystemError(e.Message);
        }
        finally
        {
            PreloadService.Hide();
        }
    }

    private void NotifySystemError(string e)
    {
        ToastService.Notify(new ToastMessage
        (
            type: ToastType.Danger,
            iconName: IconName.Bug,
            title: "ÏãúÏä§ÌÖúÏóêÎü¨!",
            helpText: $"{DateTime.Now.ToLocalTime()}",
            message: $"Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. : {e}"
        ));
    }

    private async Task LoadSoldItem()
    {
        _soldItems = await GetSoldItems();

        _totalPrice = _soldItems
            .Sum(item => item.Price) ?? 0;

        await _grid.RefreshDataAsync();
    }

    private async Task SoldItemReload()
    {
        try
        {
            PreloadService.Show();

            await LoadSoldItem();
        }
        catch (Exception e)
        {
            NotifySystemError(e.Message);
        }
        finally
        {
            PreloadService.Hide();
        }
    }

    public class SoldItemInput
    {
        public int ItemId { get; set; }

        public int ItemIcon { get; set; }

        [Required(ErrorMessage = "ÏïÑÏù¥ÌÖúÎ™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.")]
        public string ItemName { get; set; } = string.Empty;

        [Required(ErrorMessage = "ÌåêÎß§ÏàòÎüâÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.")]
        public int Quantity { get; set; } = 1;

        [Required(ErrorMessage = "ÌåêÎß§Í∏àÏï°ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.")]
        public int Price { get; set; }

        [Required(ErrorMessage = "ÌåêÎß§ÏùºÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.")]
        public DateOnly SoldDate { get; set; } = DateOnly.FromDateTime(DateTime.Now);

        public string? Authorization { get; set; }

        [JsonIgnore] public string ItemDesc => ItemId == 0 ? string.Empty : $"[#{ItemId}] {ItemName}";

        [JsonIgnore]
        public string ItemIconUrl
            => ItemId == 0
                ? "https://demos.blazorbootstrap.com/images/placeholder.png"
                : $"https://ff14.tar.to/assets/img/icon/{IconGroup}/{ItemIcon:D6}_hr1.png";

        private string IconGroup
        {
            get
            {
                var str = $"{ItemIcon:D6}";

                char[] charArray = str.ToCharArray();

                for (int i = 3; i < charArray.Length; i++)
                {
                    charArray[i] = '0';
                }

                return new string(charArray);
            }
        }

        public void InitializeInput()
        {
            ItemId = 0;
            ItemIcon = 0;
            ItemName = string.Empty;
            Quantity = 1;
            Price = 0;
        }

        public void Reset()
        {
            InitializeInput();
            SoldDate = DateOnly.FromDateTime(DateTime.Now);
        }
    }

    public class ItemDetail
    {
        public int Id { get; init; }
        public int Icon { get; init; }
        public string Name { get; init; } = null!;
        public int Level { get; init; }
    }


}
